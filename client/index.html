<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PurpleBeats - Music Streaming</title>
  <meta name="theme-color" content="#6c5ce7" />
  <link rel="icon" href="/favicon.ico" />
</head>
<body>
  <div id="root"></div>
  
  <!-- Pi SDK Loading -->
  <script src="https://sdk.minepi.com/pi-sdk.js" onerror="console.error('‚ùå Failed to load Pi SDK')"></script>
  <script>
    (function() {
      console.log("üîÑ PurpleBeats initializing Pi SDK...");
      
      // Check Pi Browser
      const userAgent = navigator.userAgent || '';
      const isPiBrowser = userAgent.includes('PiBrowser') || userAgent.includes('Pi Network');
      console.log('üîç User Agent:', userAgent);
      console.log('üîç Is Pi Browser:', isPiBrowser);
      
      if (!isPiBrowser) {
        console.warn('‚ö†Ô∏è Not running in Pi Browser - some features may not work');
      }

      function waitForPiSDK(callback, attempts = 0) {
        const maxAttempts = 50; // 5 seconds max
        
        if (attempts >= maxAttempts) {
          console.error("‚ùå Pi SDK failed to load after maximum attempts");
          return;
        }
        
        if (typeof window !== 'undefined' && window.Pi) {
          console.log("‚úÖ Pi SDK loaded successfully");
          callback();
        } else {
          setTimeout(() => waitForPiSDK(callback, attempts + 1), 100);
        }
      }

      function initPurpleBeatsPi(appId) {
        try {
          if (!window.Pi) {
            throw new Error("Pi SDK not available");
          }
          
          const currentDomain = window.location.hostname;
          const isDevelopment = currentDomain === 'localhost' || currentDomain.includes('127.0.0.1');
          
          const piConfig = {
            version: "2.0",
            sandbox: true, // Force testnet for PurpleBeats development
            appId: appId
          };
          
          console.log("üîß Initializing PurpleBeats Pi SDK:", piConfig);
          console.log("üîß Domain:", currentDomain, "isDevelopment:", isDevelopment);
          
          window.Pi.init(piConfig);
          window.Pi.initialized = true;
          
          console.log("‚úÖ PurpleBeats Pi SDK initialized successfully");
          
          // Add Pi methods to global scope for easy access
          window.PurpleBeats = {
            piLogin: async () => {
              if (!window.Pi) throw new Error("Pi SDK not loaded");
              return await window.Pi.authenticate(["username", "payments"]);
            },
            piPayment: async (amount, memo, metadata) => {
              if (!window.Pi) throw new Error("Pi SDK not loaded");
              return await window.Pi.createPayment({
                amount: amount,
                memo: memo,
                metadata: metadata
              });
            }
          };
          
        } catch (e) {
          console.error("‚ùå PurpleBeats Pi.init error:", e);
        }
      }

      // Fetch config and initialize Pi SDK
      fetch("/api/pi-config")
        .then((res) => {
          console.log("üì° PurpleBeats Pi config status:", res.status);
          if (!res.ok) {
            // Don't throw error - app should still work without Pi SDK
            console.warn(`‚ö†Ô∏è Pi config failed with status ${res.status}`);
            return null;
          }
          return res.json();
        })
        .then((config) => {
          if (config && config.appId) {
            console.log("üîß PurpleBeats Pi Config received:", config);
            
            // Wait for Pi SDK then initialize
            waitForPiSDK(() => {
              initPurpleBeatsPi(config.appId);
            });
          } else {
            console.warn("‚ö†Ô∏è No valid Pi config received - app will work with limited functionality");
          }
        })
        .catch((err) => {
          console.warn("‚ö†Ô∏è PurpleBeats Pi config failed:", err);
          console.log("‚ÑπÔ∏è App will continue without Pi SDK functionality");
        });
    })();
  </script>
  
  <script type="module" src="/src/main.tsx"></script>
</body>
</html>